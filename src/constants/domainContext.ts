/**
 * 人材紹介ビジネス ドメイン知識ベース
 * Issue #2: ファネル構造・隠れた課題・マッチング変数を定義し、プロンプトに注入する
 */

export const HR_REGEX = /人材|採用|エージェント|CA|RA|転職|求人|スカウト|人事|キャリア|紹介会社/i;

/** 求職者ファネル（CA側） */
export const SEEKER_FUNNEL = [
  { stage: '認知・流入',   cr: '2-5%',   desc: 'スカウト・広告・口コミで候補者がサービスを知る' },
  { stage: '登録',         cr: '30-50%', desc: '会員登録・プロフィール入力' },
  { stage: 'CA面談',       cr: '60-80%', desc: 'キャリアの棚卸し・希望条件ヒアリング' },
  { stage: '求人紹介',     cr: '40-60%', desc: 'マッチする求人を推薦' },
  { stage: '応募・選考',   cr: '30-50%', desc: '書類選考→面接' },
  { stage: '内定承諾→入社', cr: '50-70%', desc: '条件交渉→入社確定（成功報酬発生）' },
] as const;

/** 企業クライアントファネル（RA側） */
export const CLIENT_FUNNEL = [
  { stage: 'リード獲得',     cr: '10-20%', desc: '新規開拓・問い合わせ' },
  { stage: '契約締結',       cr: '20-40%', desc: '基本契約書締結・手数料率合意（年収の30-35%）' },
  { stage: '求人受注・票作成', cr: '60-80%', desc: '求人要件ヒアリング→求人票作成' },
  { stage: 'リピート受注',   cr: '40-60%', desc: '成約実績→継続依頼・追加求人' },
] as const;

/** 業界特有の隠れた構造課題 */
export const HIDDEN_ISSUES = [
  'エージェント不信（過去の紹介失敗体験で候補者がエージェント自体を敬遠）',
  '情報非対称性（企業の実態・社風が候補者に届かず意思決定が歪む）',
  'CA属人化（個人の力量差がサービス品質・成約率に直結）',
  'ターゲット認知ギャップ（理想的な候補者層にサービスが届いていない）',
  '早期退職リスク（入社3ヶ月以内退職→返金発生で売上が消失）',
] as const;

/** マッチング精度を左右する3変数 */
export const MATCHING_VARS = [
  { v: 'スキルマッチ',     desc: '技術力・経験・資格の合致度' },
  { v: 'カルチャーマッチ', desc: '組織風土・働き方・価値観の適合度' },
  { v: '期待値マッチ',     desc: '年収・キャリアパス・働き方条件の合意度' },
] as const;

/** HR文脈かどうかを判定 */
export function isHRContext(productService: string, issueTexts: string[]): boolean {
  return HR_REGEX.test(productService + ' ' + issueTexts.join(' '));
}

/**
 * プロンプト注入用 HR ドメインコンテキスト
 * Pro mode: 詳細版（~400 tokens）
 * Free mode: 圧縮版（~100 tokens）
 */
export function getHRDomainContext(proMode: boolean): string {
  if (proMode) {
    return `
【人材紹介ビジネス ドメイン知識】
■ 収益モデル: 成功報酬型（採用者の初年度想定年収×30-35%）。入社確定まで売上ゼロ。早期退職→返金リスクあり。
■ CA（キャリアアドバイザー）: 求職者側担当。面談→求人紹介→選考支援→条件交渉→入社フォロー
■ RA（リクルーティングアドバイザー）: 企業側担当。開拓→契約→要件ヒアリング→求人票作成→候補者推薦

■ 求職者ファネル（各段階の業界目安転換率 ※企業規模・領域で大きく変動）:
${SEEKER_FUNNEL.map(s => `  ${s.stage}: 目安${s.cr}`).join('\n')}

■ 企業クライアントファネル（業界目安 ※変動大）:
${CLIENT_FUNNEL.map(s => `  ${s.stage}: 目安${s.cr}`).join('\n')}

■ 隠れた構造課題:
${HIDDEN_ISSUES.map(h => `  - ${h}`).join('\n')}

■ マッチング精度3変数: ${MATCHING_VARS.map(m => `${m.v}（${m.desc}）`).join('、')}

【分析指示】
- ユーザーの課題がファネルのどの段階のボトルネックか特定し funnelStage に出力
- なぜなぜ分析で「表面課題→根本原因→真のイシュー」を掘り下げ understanding に構造的に記述
- keyIssue に最重要イシューを1文で特定
- 数値は「業界平均比○倍」「現状比+○%」等の相対表現を優先。上記転換率は業界目安であり、ユーザー入力に具体数値がない場合は絶対値を断言せず「一般的に」「業界目安では」と付記する`.trim();
  }
  return `[HR文脈] 成功報酬型（年収×30-35%）。CA=求職者担当/RA=企業担当。求職者ファネル: 認知→登録→面談→紹介→応募→内定承諾。企業: リード→契約→受注→リピート。課題: エージェント不信・情報非対称性・CA属人化・認知ギャップ・早期退職返金。マッチング3軸: スキル・カルチャー・期待値。数値は相対値優先（業界平均比など）、推定値には「業界目安」と付記。funnelStageにボトルネック段階、keyIssueに最重要イシューを出力。`;
}
