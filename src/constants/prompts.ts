export const TYPES: Record<string, string> = {
  'ops': '営業・業務オペレーション',
  'marketing': 'マーケティング・集客',
  'growth': 'グロース・収益拡大',
  'cx': '顧客体験・関係構築',
  'product': 'サービス・事業改善',
  'dx': 'デジタル化・業務効率化',
  'innovation': '新規事業・イノベーション',
  'other': '経営戦略・その他',
  'design-system': 'ブランド・UI統一',
};

export const ISSUE_TPL: Record<string, string[]> = {
  'product': ['成長鈍化','差別化不足','顧客維持率低下','収益性悪化','競合優位性の喪失','プロダクトMF未達','機能肥大化・技術的負債'],
  'marketing': ['認知不足','検索流入の停滞','メディアCVR低下','リード獲得コスト高騰','ターゲット乖離','チャネル依存リスク','コンテンツ資産不足'],
  'growth': ['新規獲得鈍化','解約・離脱増加','LTV低下','オウンドメディアの頭打ち','市場飽和','価格競争の激化','アップセル機会損失'],
  'innovation': ['新規事業仮説未検証','社内承認困難','投資回収見通し不明','組織硬直','競合先行リスク','技術選定の迷い','MVP定義の曖昧さ'],
  'cx': ['顧客満足度低下','初回体験の悪化','サポート負荷増','顧客離脱','期待値ギャップ','フィードバック収集不足','パーソナライズ未対応'],
  'ops': ['営業属人化','顧客管理（CRM）未活用','アウトリーチ効率低下','商談化率の低下','事務作業過多','KPI可視化不足','ナレッジ共有の欠如'],
  'dx': ['手作業・アナログ業務多数','データ分散・一元管理不可','ツール連携不足','業務可視化できない','変革への抵抗','セキュリティ懸念','ROI測定困難'],
  'design-system': ['ブランド一貫性の欠如','制作コスト増加','承認フロー複雑化','ガイドライン未整備','外注品質ばらつき','アクセシビリティ未対応','デザイン-開発ギャップ'],
  'other': ['収益構造の課題','市場縮小・業界変化','組織・人材の課題','競合との差別化','意思決定の遅さ','リソース配分の非効率','ステークホルダー合意形成']
};

/** プロダクト/サービスのキーワード → 追加課題サジェスト */
const PRODUCT_HINTS: [RegExp, string[]][] = [
  [/人材|採用|エージェント|CA|転職|求人|スカウト|人事|キャリア|人材紹介|派遣/i, ['CA生産性の限界','求人と求職者のミスマッチ','スカウト返信率低下','内定承諾率の停滞']],
  [/SaaS|サブスク|月額/i,          ['解約率（チャーン）','オンボーディング離脱','プラン設計の最適化','利用定着率の低下']],
  [/メディア|コンテンツ|SEO|記事/i, ['PV・UU伸び悩み','回遊率の低下','収益化モデルの壁','コンテンツ品質のばらつき']],
  [/EC|コマース|物販|ストア/i,      ['カゴ落ち率','リピート購入率低下','在庫回転効率','配送コスト圧迫']],
  [/AI|機械学習|自動化|生成/i,      ['精度と期待値のギャップ','学習データの質・量不足','運用コスト増大','説明可能性の課題']],
  [/アプリ|モバイル|ネイティブ/i,    ['DAU/MAU比率低下','ストア評価の低迷','プッシュ通知疲れ','OS対応コスト']],
  [/BtoB|B2B|法人|エンタープライズ/i,['商談リードタイム長期化','決裁者アクセス困難','導入障壁の高さ','カスタマイズ要求過多']],
  [/マッチング|プラットフォーム|マーケットプレイス/i, ['需給バランスの偏り','流動性の確保','品質担保の難しさ','手数料モデルの限界']],
  [/DX|デジタル|業務改善/i,         ['現場の抵抗','既存システム連携','効果測定の曖昧さ','推進体制の不足']],
  [/教育|研修|ラーニング/i,         ['学習継続率の低下','効果測定の難しさ','コンテンツ陳腐化','受講者モチベーション']],
  [/金融|フィンテック|決済/i,       ['規制対応コスト','セキュリティ要件','信頼性担保','UXと安全性の両立']],
  [/CRM|顧客管理|営業支援/i,       ['データ入力負荷','活用率の低さ','営業プロセスとの乖離','分析活用の未成熟']],
];

/**
 * sessionType × productService でサジェストをマージ（7個以上を保証）
 */
export function getIssueSuggestions(sessionType: string, productService: string): string[] {
  const base = ISSUE_TPL[sessionType] ?? ISSUE_TPL.other;
  if (!productService.trim()) return base;

  const extras: string[] = [];
  for (const [re, hints] of PRODUCT_HINTS) {
    if (re.test(productService)) extras.push(...hints);
  }
  // base を優先しつつ、extras から重複排除して追加
  const seen = new Set(base);
  const merged = [...base];
  for (const e of extras) {
    if (!seen.has(e)) { seen.add(e); merged.push(e); }
  }
  return merged;
}

/** 親課題テキスト → サブ課題サジェスト */
const SUB_ISSUE_HINTS: [RegExp, string[]][] = [
  [/人材|採用|CA|スカウト|エージェント|人材紹介|派遣/,  ['ターゲット人材へのリーチ不足', 'スカウト文の個別最適化ができていない', '面談→内定の歩留まり悪化']],
  [/成長.*鈍化|売上.*停滞|伸び悩/,      ['新規顧客の獲得チャネルが枯渇', '既存顧客からの追加受注が減少', '市場成長率を下回るシェア推移']],
  [/差別化|競合|ポジション/,            ['競合との機能比較で劣位の領域がある', '価格以外の選定理由が不明確', '顧客が競合に乗り換える理由の未把握']],
  [/離脱|解約|チャーン/,                ['オンボーディング未完了での早期離脱', '利用頻度低下→自然解約のパターン', '競合の無料プランへの流出']],
  [/コスト|収益|利益率/,                ['売上原価率の上昇傾向', '固定費比率が高く損益分岐点が遠い', '値引き・割引の常態化']],
  [/属人化|ナレッジ|ノウハウ/,           ['キーパーソン不在時に業務が停滞', 'マニュアル・手順書が未整備', '新人の立ち上がりに時間がかかる']],
  [/CRM|顧客管理|データ/,               ['入力工数が高く現場が使いたがらない', 'データが古い・不正確で信頼できない', '分析・レポート機能を活用できていない']],
  [/認知|ブランド|流入/,                ['ターゲット層へのリーチが不足', 'ブランド想起率が低い', '広告依存でオーガニック流入が少ない']],
  [/CV|コンバージョン|商談化/,           ['LPの離脱ポイントが未特定', 'フォーム入力のハードルが高い', '初回接点から商談への導線が弱い']],
  [/オンボーディング|初回体験|UX/,       ['初期設定が複雑で完了しない', '価値を実感するまでの時間が長い', 'ヘルプ・ガイドが不十分']],
  [/マーケ|広告|リード/,                ['チャネル別ROIの可視化不足', 'リード品質と量のトレードオフ', 'ナーチャリングフローが未設計']],
  [/DX|デジタル|自動化/,                ['現場の変革への抵抗', '既存システムとの連携が困難', '投資対効果の測定方法が未確立']],
  [/価格|プラン|単価/,                  ['競合との価格差の説明が困難', 'プラン間の機能差が不明瞭', '値上げ時の解約リスク']],
  [/NPS|満足度|フィードバック/,          ['収集方法・頻度が不十分', '収集した声の分析・活用ができていない', '改善アクションへの落とし込みが弱い']],
];

/**
 * 親課題テキストに応じたサブ課題サジェストを返す
 */
export function getSubIssueSuggestions(parentText: string): string[] {
  if (!parentText.trim()) return [];
  const results: string[] = [];
  for (const [re, hints] of SUB_ISSUE_HINTS) {
    if (re.test(parentText)) results.push(...hints);
  }
  return results;
}

// Free mode (no API key) — limited tiers
export const FREE_DEPTH: Record<number, { label: string; desc: string; ideas: number; wait: string; maxTokens: number }> = {
  1: { label: 'Lite',     desc: '速報',    ideas: 3, wait: '〜1分',  maxTokens: 6000  },
  2: { label: 'Standard', desc: '標準',    ideas: 5, wait: '1-3分',  maxTokens: 12000 },
  3: { label: 'Deep',     desc: '詳細',    ideas: 7, wait: '3-5分', maxTokens: 16000 },
};

// Pro mode (user's own API key) — full tiers
// gpt-4o-mini 出力 $0.60/1M tokens 基準: 32,000 tokens ≈ 約3円
export const PRO_DEPTH: Record<number, { label: string; desc: string; ideas: number; wait: string; maxTokens: number }> = {
  1: { label: 'Quick',     desc: '概要',       ideas: 3,  wait: '〜5分',   maxTokens: 8000 },
  2: { label: 'Standard',  desc: '標準',       ideas: 6,  wait: '〜15分',  maxTokens: 16000 },
  3: { label: 'Deep',      desc: '詳細',       ideas: 8,  wait: '〜30分',  maxTokens: 24000 },
  4: { label: 'High-Class', desc: 'トップティア', ideas: 10, wait: '30分+',   maxTokens: 32000 },
};

export const EXAMPLE_PRODUCTS: Record<string, string[]> = {
  'product':        ['HR人材サービス', 'ATS（採用管理システム）', 'サブスク型SaaS', 'マッチングアプリ'],
  'marketing':      ['ITエンジニア向け転職メディア', 'エンジニア採用支援SaaS', 'B2Bマーケティング支援', 'ECサイト（アパレル）'],
  'growth':         ['エンジニア特化型転職サービス', 'ハイスキル人材プラットフォーム', '動画配信サービス', '教育系SaaS'],
  'innovation':     ['AIマッチングエンジン', '採用DXプラットフォーム', '生成AI活用プロダクト', 'ESG管理ツール'],
  'cx':             ['CA（キャリアアドバイザー）支援ツール', '候補者ポータル', 'D2C化粧品ブランド', 'カスタマーサクセスSaaS'],
  'ops':            ['CRM（人材紹介特化）', '求職者フォロー自動化', '物流管理システム', '店舗管理SaaS'],
  'dx':             ['CA業務のAI自動化', 'マッチングデータ基盤構築', '電子帳簿保存対応ツール', '建設現場DX'],
  'design-system':  ['求人サイト（マルチブランド）', 'エンタープライズHR SaaS', '金融系モバイルアプリ', 'グローバルSaaS'],
  'other':          ['IT人材紹介 事業再設計', '人材紹介×AIエージェント', '新規市場参入戦略', 'M&A後のPMI'],
};

export const GOAL_TEMPLATES: Record<string, string[]> = {
  'product':        ['顧客維持率（リテンション）改善', 'プロダクトMF達成・検証', '技術的負債削減・開発速度改善', 'ARPU・単価向上', 'ユーザー体験（UX）改善', '新機能リリース速度向上', '競合との差別化確立'],
  'marketing':      ['リード獲得数の拡大', 'CAC（獲得コスト）削減', 'オーガニック流入・SEO強化', 'CV率（転換率）改善', 'ブランド認知度向上', 'コンテンツ資産の構築', 'チャネルミックス最適化'],
  'growth':         ['売上・ARR成長率の加速', 'チャーンレート（解約率）低減', 'LTV向上・顧客単価改善', 'NRR（売上維持率）110%以上', '新規顧客獲得数の拡大', 'アップセル・クロスセル強化', '市場シェア拡大'],
  'innovation':     ['MVP・PoCの検証完了', 'PMFスコア40%以上達成', '経営承認・投資判断の獲得', '新収益モデルの確立', '市場参入戦略の策定', 'パイロット顧客の獲得', '技術検証・実現性確認'],
  'cx':             ['顧客満足度（NPS）向上', '初回体験・オンボーディング改善', '顧客対応品質の均一化', 'リピート率・継続率向上', 'サポートコスト効率化', 'フィードバック収集・活用体制', 'パーソナライズ対応の実現'],
  'ops':            ['一人当たり生産性向上', 'プロセスの標準化・脱属人化', 'CRM・ツール活用率向上', '商談化率・成約率改善', '事務工数削減・自動化', 'KPI可視化・データドリブン化', '新人の早期戦力化'],
  'dx':             ['業務プロセスのデジタル化', 'データ一元管理・基盤構築', 'AI・自動化による工数削減', 'レガシーシステム刷新', 'ツール定着率向上', 'DX投資のROI可視化', 'セキュリティ・コンプライアンス対応'],
  'design-system':  ['デザインシステム採用率向上', 'ブランド一貫性の確保', '制作コスト削減・効率化', 'アクセシビリティ準拠', 'マルチプロダクト展開対応', '承認フロー簡略化', 'デザイン-開発連携強化'],
  'other':          ['収益構造の改善', '競合差別化の確立', '組織・人材の強化', '意思決定スピード向上', '新市場・新領域への参入', 'コスト構造の最適化', 'ステークホルダー合意形成'],
};

/** プロダクト/サービスのキーワード → 追加目標サジェスト */
const PRODUCT_GOAL_HINTS: [RegExp, string[]][] = [
  [/人材|採用|エージェント|CA|転職|求人|スカウト|人事|キャリア|人材紹介|派遣/i, [
    'CA一人当たり成約件数+50%', 'スカウト返信率改善', '内定承諾率向上',
    'ハイスキル人材の登録比率向上', '求人-求職者マッチング精度改善',
    'クライアント企業リピート率向上', '成約単価・フィー向上',
  ]],
  [/SaaS|サブスク|月額/i, [
    'MRR・ARR成長率の加速', '解約率（チャーン）低減',
    'オンボーディング完走率向上', 'フリー→有料転換率改善',
  ]],
  [/メディア|コンテンツ|SEO|記事/i, [
    'PV・UU成長', 'コンテンツCV率改善',
    'EEAT・AIO対応強化', '収益化モデル多角化',
  ]],
  [/EC|コマース|物販|ストア/i, [
    'カゴ落ち率改善', 'リピート購入率向上',
    '顧客単価向上', '在庫回転効率改善',
  ]],
  [/AI|機械学習|自動化|生成/i, [
    'AI精度・品質の改善', '自動化率向上',
    '運用コスト削減', 'AI活用業務比率向上',
  ]],
  [/物流|配送|倉庫/i, [
    '配送効率・ルート最適化', '燃料費削減',
    '残業時間削減', '配車計画の自動化',
  ]],
  [/BtoB|B2B|法人|エンタープライズ/i, [
    '商談リードタイム短縮', '大型案件の成約率向上',
    '導入事例の横展開', 'パートナーチャネル構築',
  ]],
];

/**
 * sessionType × productService で目標サジェストを生成
 */
export function getGoalSuggestions(sessionType: string, productService: string): string[] {
  const base = GOAL_TEMPLATES[sessionType] ?? GOAL_TEMPLATES.other;
  if (!productService.trim()) return base;

  const extras: string[] = [];
  for (const [re, hints] of PRODUCT_GOAL_HINTS) {
    if (re.test(productService)) extras.push(...hints);
  }
  const seen = new Set(base);
  const merged = [...base];
  for (const e of extras) {
    if (!seen.has(e)) { seen.add(e); merged.push(e); }
  }
  return merged;
}

import type { IssueTemplate } from '../types';
export const ISSUE_TEMPLATES: Record<string, IssueTemplate[]> = {
  'product': [
    { text: '成長鈍化・売上停滞', detail: '前年比成長率が業界平均を下回り、新規顧客獲得と既存顧客拡大の両方が鈍化', sub: ['新規顧客獲得コストが上昇している', '既存顧客からのリピート・追加受注が減少'] },
    { text: 'サービスの差別化不足', detail: '競合と比較したときの明確な優位性をセールスが説明できない', sub: ['価格競争に引き込まれやすい', 'ターゲット顧客への価値訴求が曖昧'] },
    { text: '収益性・利益率の悪化', detail: '売上は伸びているが営業利益率が低下、コスト構造の見直しが必要', sub: [] },
  ],
  'marketing': [
    { text: '検索流入（SEO）の伸び悩み', detail: '主要キーワードでの順位下落や、Googleアルゴリズム変化による流入減少', sub: ['特定メディアへの集客依存が高い', 'コンテンツの更新頻度と質の低下'] },
    { text: 'メディアからのCVR（転換率）低下', detail: 'PV数は維持できているが、会員登録や問い合わせへの転換率が低下傾向', sub: ['読者ターゲットと商材のミスマッチ', '記事からCVポイントへの誘導が不十分'] },
    { text: 'リード獲得コストの高騰', detail: '広告・施策あたりのCPA（獲得単価）が目標を超過し、ROIが悪化', sub: ['特定チャネルへの依存度が高い', 'オーガニック流入・紹介が頭打ち'] },
    { text: 'コンテンツ・情報発信のROI不明', detail: '発信量は多いが成約に貢献しているかが測定できていない', sub: ['アトリビューション（貢献度測定）が未整備', 'ターゲット外の読者が多くCV率が低い'] },
  ],
  'growth': [
    { text: 'オウンドメディアの成長限界', detail: '既存チャネルからの集客が飽和し、新規獲得のチャネル拡大が急務', sub: ['SEOキーワードが枯渇している', 'SNSや動画など新チャネルへの展開が遅れ'] },
    { text: '高単価・優良顧客の獲得難', detail: '成約単価の高い顧客層の獲得比率が低く、収益性の高い案件が少ない', sub: ['価値訴求が不足している', '信頼醸成のための実績・事例が少ない'] },
    { text: '解約・顧客離脱の増加', detail: '既存顧客の継続率・リピート率が低下し、新規獲得コストで補填できていない', sub: ['顧客の期待値と実際の成果にギャップ', '定期フォローやサクセス支援が不足'] },
  ],
  'cx': [
    { text: '顧客満足度・信頼の低下', detail: '顧客からの期待に応えられず、NPS・満足度スコアが低下傾向', sub: ['「担当者によって対応品質が違う」という声が多い', '課題解決スピードが遅いと感じられている'] },
    { text: '担当者の対応品質のばらつき', detail: 'トップ担当者と平均担当者の成果に大きな差があり、顧客体験が均一でない', sub: ['対応プロセスが標準化されておらず個人スキルに依存', '新人育成に時間がかかる'] },
    { text: '顧客との関係構築・フォロー不足', detail: '成約・納品後の関係維持が薄く、リピート・紹介につながっていない', sub: ['定期コンタクトの仕組みがない', '顧客の変化や課題をリアルタイムで把握できていない'] },
  ],
  'ops': [
    { text: '営業活動の非効率・属人化', detail: '電話・メール中心の営業で商談化率が低く、担当者工数の多くが事務作業に費やされている', sub: ['トークスクリプト・フォロー手順が個人任せで共有されていない', 'アプローチのタイミングや優先度が感覚に依存'] },
    { text: 'CRM・顧客管理ツールの活用不足', detail: '顧客・案件情報がツールに蓄積されているだけで、営業改善や行動トリガーに使われていない', sub: ['入力負荷が高く現場が使いたがらない', 'データから次のアクションや売上予測が見えない'] },
    { text: 'ナレッジ共有・業務標準化の欠如', detail: 'トップ担当者のやり方が共有されておらず、退職・異動時に成果が再現できない', sub: ['成功事例・失注の振り返りが組織で共有されていない', '新人が一人立ちするまでに時間がかかる'] },
    { text: '提案・書類業務の品質課題', detail: '求人票・提案書・職務経歴書など顧客に渡す資料の品質が担当者によりバラバラ', sub: ['作成に時間がかかりすぎて営業活動を圧迫している', 'テンプレートや品質基準が整備されていない'] },
  ],
  'dx': [
    { text: 'アナログ・手作業業務の多さ', detail: '日常業務の多くが手入力・電話・メール・Excelに依存しており、コストとミスが発生', sub: ['デジタル化への抵抗感や習熟コストが障壁になっている', '改善したくても誰も旗を振れていない'] },
    { text: 'データの分散・一元管理の欠如', detail: '顧客情報・案件情報・業績データが複数のツールに散在し、全体像が把握できない', sub: ['集計・レポート作成に毎回時間がかかる', '意思決定に必要な情報がリアルタイムで取れない'] },
    { text: 'ツール投資の効果が出ていない', detail: 'CRM・MAなどを導入しているが現場定着率が低く、投資対効果が出ていない', sub: ['導入後の運用設計・現場教育が不十分', '現場ニーズとツール設計がかみ合っていない'] },
  ],
  'innovation': [
    { text: '新規事業の仮説検証が進まない', detail: 'アイデアはあるが「誰の・どんな課題を解決するか」の検証が不十分で意思決定できない', sub: ['顧客ヒアリングの数と質が不足', '定量データが取れていない'] },
    { text: '社内承認・リソース確保の壁', detail: '既存事業との利害対立や稟議プロセスで、新規事業へのリソース投入が遅れている', sub: ['経営層への説明材料（ROI試算・市場規模）が準備できていない', '推進者の権限が弱い'] },
    { text: '市場・競合の変化への対応遅れ', detail: '業界構造が変化しているにもかかわらず、既存事業の延長線上の発想から抜け出せていない', sub: ['情報収集・競合分析の頻度が高い', '変化に対するアクションが後手に回っている'] },
  ],
  'design-system': [
    { text: 'ブランドの一貫性が保てていない', detail: '複数の媒体・担当者間でトンマナ・見た目がバラバラで、信頼感・統一感が欠けている', sub: ['ガイドラインがあっても現場で守られていない', '外注先によって品質にばらつきがある'] },
    { text: '制作コストと納期の問題', detail: 'コンテンツ・資料制作に時間とコストがかかりすぎ、スピード感が出せていない', sub: ['テンプレートや素材が整備されていない', '承認フローが複雑で無駄なやり取りが多い'] },
    { text: '顧客接点のメッセージ統一不足', detail: 'ウェブ・資料・営業トークで伝わるメッセージが統一されておらず、顧客の混乱を招いている', sub: [] },
  ],
  'other': [
    { text: '市場縮小・業界構造の変化', detail: '業界全体が縮小傾向で、従来のビジネスモデルの賞味期限が近づいている', sub: ['新たな競合・代替サービスの台頭', '顧客のニーズや購買行動が変化している'] },
    { text: 'ターゲット顧客とのズレ', detail: '経営・営業が想定する顧客像と、実際にアプローチできている顧客が一致していない', sub: ['顧客のメンタルモデル・行動様式の理解が浅い', '訴求メッセージが的外れになっている'] },
    { text: '組織・人材の課題', detail: 'キーパーソンへの業務集中、採用・育成の遅れ、部門間連携の弱さが成長の足かせになっている', sub: ['ノウハウが特定個人に依存している', 'チームとしての実行力が弱い'] },
    { text: '収益構造の課題', detail: '売上は確保できているが利益率が低く、事業の持続可能性に懸念がある', sub: ['コスト構造の見直しが後回しになっている', '高収益セグメントへの集中が不十分'] },
  ],
};

export const SUGGEST: Record<string, string[]> = {
  'product': ['収益性の高いセグメントへの選択と集中は？','競合との差別化ポジションの再設計は？','既存顧客のLTV最大化策は？','新規顧客獲得コスト削減のレバーは？','サービス品質と利益率の両立アプローチは？'],
  'marketing': ['ターゲットのメンタルモデル・購買行動の分析は？','コストあたりリード獲得の最適化は？','商談化率を上げる初期接点の改善は？','口コミ・紹介を生む仕組みの設計は？','施策ごとのROI可視化と優先順位の付け方は？'],
  'growth': ['収益性の高い顧客セグメントの特定と集中は？','解約・離脱防止のための早期シグナルと対応策は？','競合に流れている顧客を取り戻す差別化は？','新規獲得コストを下げる紹介・口コミ活用は？','単価向上と成約率改善を両立するアプローチは？'],
  'innovation': ['新規事業の最重要仮説の特定と検証方法は？','経営承認を得るためのROI・市場規模の示し方は？','既存事業リソースを活かした新規事業の設計は？','競合・市場変化を先取りするための情報収集設計は？','小さく早く試すPoC設計の方法は？'],
  'cx': ['顧客が感じる期待値と実体験のギャップの特定は？','担当者間の対応品質を均一化する仕組みは？','顧客のリピート・紹介を生むフォロー設計は？','顧客満足度を測定・改善するサイクルの作り方は？','クレームを信頼回復の機会に変える対応設計は？'],
  'ops': ['営業活動の商談化率を上げるためのボトルネック分析は？','CRM・管理ツールを現場が使いたくなる運用設計は？','トップ担当者のノウハウを組織に広げる方法は？','提案・書類業務の品質標準化と工数削減の両立は？','新人が早期に成果を出せるオンボーディング設計は？'],
  'dx': ['業務のどこから優先的にデジタル化すべきか？','導入ツールを現場に定着させるための変革管理は？','データを意思決定に活かす仕組みの作り方は？','AI・自動化で削減できる工数の優先順位は？','投資対効果を経営層に説明するROI試算の方法は？'],
  'design-system': ['ブランド統一のための優先施策と実行順序は？','制作コストと品質を両立するテンプレート設計は？','外注先の品質管理と内製化の判断基準は？','顧客接点ごとのメッセージ統一のアプローチは？','承認フロー簡略化と品質保証の両立方法は？'],
  'other': ['現状の強みを活かした差別化ポジションの設計は？','市場変化に対応するための事業モデルの見直しは？','組織・人材の課題を解決する優先アクションは？','短期の収益改善と中長期の競争力強化の両立は？','意思決定を加速するための情報・判断軸の整理は？']
};

/** プロダクト/サービスのキーワード → 深掘り質問 */
const PRODUCT_SUGGEST_HINTS: [RegExp, string[]][] = [
  [/人材|採用|エージェント|CA|転職|求人|スカウト|人事|キャリア|人材紹介|派遣/i, ['CA一人当たり生産性の限界を突破するには？','スカウト返信率を劇的に上げるアプローチは？','求人-求職者マッチング精度の改善策は？']],
  [/SaaS|サブスク|月額/i,          ['解約率を下げるオンボーディング最適化は？','プラン・価格設計で単価を上げるには？','フリーミアムから有料転換を促す導線は？']],
  [/メディア|コンテンツ|SEO|記事/i, ['コンテンツのマネタイズ戦略の多角化は？','PV依存から脱却する収益モデルは？','読者エンゲージメントを高める仕組みは？']],
  [/EC|コマース|物販|ストア/i,      ['カゴ落ち率を改善するUX施策は？','リピート購入を促すCRM設計は？','商品単価と購入頻度の最適バランスは？']],
  [/AI|機械学習|自動化|生成/i,      ['AI精度と事業KPIを直結させるには？','人間のオペレーションとAIの役割分担設計は？','AI導入の費用対効果をどう可視化するか？']],
  [/アプリ|モバイル|ネイティブ/i,    ['DAU/MAU比率を改善するリテンション施策は？','アプリストア評価を向上させる戦略は？','プッシュ通知の最適な頻度とタイミングは？']],
  [/BtoB|B2B|法人|エンタープライズ/i,['決裁者にリーチするコンテンツ戦略は？','商談リードタイム短縮の施策は？','導入事例を横展開する仕組みは？']],
  [/マッチング|プラットフォーム|マーケットプレイス/i, ['需給バランスを最適化する施策は？','プラットフォームの信頼性を高める仕組みは？','手数料モデルの最適化は？']],
  [/DX|デジタル|業務改善/i,         ['現場の変革抵抗を乗り越えるチェンジマネジメントは？','段階的DXのロードマップ設計は？','DX投資のROI測定フレームワークは？']],
];

/** 入力済み課題キーワード → 追加深掘り質問 */
const ISSUE_SUGGEST_HINTS: [RegExp, string[]][] = [
  [/成長.*鈍化|売上.*停滞|伸び悩/,    ['成長ドライバーの再特定と優先順位付けは？']],
  [/差別化|競合|ポジション/,           ['競合が模倣しにくい独自価値の構築は？']],
  [/離脱|解約|チャーン/,               ['離脱予兆の早期検知と予防アクションは？']],
  [/コスト|収益|利益率/,               ['コスト構造の抜本的な見直しポイントは？']],
  [/属人化|ナレッジ|ノウハウ/,          ['暗黙知を組織知に変換する仕組みは？']],
  [/CRM|顧客管理|データ/,              ['データ活用で意思決定の精度を上げるには？']],
  [/認知|ブランド|流入/,               ['ターゲット認知を効率的に獲得するチャネル選定は？']],
  [/CV|コンバージョン|商談化/,          ['CVR改善のためのボトルネック特定と優先施策は？']],
];

/**
 * sessionType × productService × 入力済み課題 で深掘りサジェスト生成（7個以上保証）
 */
export function getDeepDiveSuggestions(sessionType: string, productService: string, issues: string[]): string[] {
  const base = SUGGEST[sessionType] ?? SUGGEST.other;
  const extras: string[] = [];

  // productService からマッチする追加質問
  if (productService.trim()) {
    for (const [re, hints] of PRODUCT_SUGGEST_HINTS) {
      if (re.test(productService)) extras.push(...hints);
    }
  }

  // 入力済み課題からマッチする追加質問
  const issueText = issues.join(' ');
  if (issueText.trim()) {
    for (const [re, hints] of ISSUE_SUGGEST_HINTS) {
      if (re.test(issueText)) extras.push(...hints);
    }
  }

  const seen = new Set(base);
  const merged = [...base];
  for (const e of extras) {
    if (!seen.has(e)) { seen.add(e); merged.push(e); }
  }
  return merged;
}
