import { BrainstormForm, AIResults } from '../types';
import { TYPES, PRO_DEPTH } from '../constants/prompts';
import { ll } from './formatters';

export const buildReportMd = (
  pn: string,
  form: BrainstormForm,
  results: AIResults,
  provN: string,
  mL: string,
  dep: number
): string => {
  const now = new Date().toLocaleString('ja-JP');
  const ses = form.sessionType === 'other' ? form.customSession : TYPES[form.sessionType];
  let md = `# AI Strategic Brainstorm Report\n\n`;
  md += `- **プロジェクト**: ${pn}\n`;
  md += `- **プロダクト/サービス**: ${form.productService}\n`;
  md += `- **セッション種別**: ${ses}\n`;
  md += `- **分析深度**: ${PRO_DEPTH[dep]?.label ?? `Lv${dep}`}\n`;
  md += `- **使用モデル**: ${provN} / ${mL}\n`;
  md += `- **生成日時**: ${now}\n\n`;
  
  md += `## 目標\n${form.teamGoals}\n\n`;
  
  const iss = form.issues.filter(x => x.text.trim());
  if (iss.length) {
    md += `## 課題\n`;
    iss.forEach(x => {
      md += `- **${x.text}**${x.detail ? `: ${x.detail}` : ''}${
        x.sub?.filter(Boolean).length ? '\n' + x.sub.filter(Boolean).map(s => `  - ${s}`).join('\n') : ''
      }\n`;
    });
    md += '\n';
  }
  
  // 競合・データ情報
  if (form.serviceUrl?.trim()) {
    md += `## 自社サービス\n${form.serviceUrl}\n\n`;
  }
  const comps = (form.competitors || []).filter(c => c.name.trim());
  if (comps.length) {
    md += `## 競合情報\n`;
    comps.forEach(c => {
      md += `- **${c.name}**${c.url ? ` (${c.url})` : ''}${c.note ? ` — ${c.note}` : ''}\n`;
    });
    md += '\n';
  }
  const kpis = (form.kpis || []).filter(k => k.label.trim() && k.value.trim());
  if (kpis.length) {
    md += `## 主要KPI実績値\n\n| KPI | 値 |\n|---|---|\n`;
    kpis.forEach(k => { md += `| ${k.label} | ${k.value} |\n`; });
    md += '\n';
  }

  if (results.keyIssue) {
    md += `## 最重要イシュー\n\n`;
    if (results.funnelStage) md += `**ボトルネック段階**: ${results.funnelStage}\n\n`;
    md += `${results.keyIssue}\n\n`;
  }

  md += `---\n\n## AI分析\n\n${results.understanding}\n\n---\n\n## 戦略アイデア\n\n`;

  const hasFeasibility = results.ideas.some(d => d.feasibility);
  results.ideas.forEach((d, i) => {
    md += `### ${i + 1}. ${d.title}\n\n${d.description}\n\n| 優先度 | 工数 | インパクト |${hasFeasibility ? ' 実現可能性 |' : ''}\n|---|---|---|${hasFeasibility ? '---|' : ''}\n| ${ll(d.priority)} | ${ll(d.effort)} | ${ll(d.impact)} |${hasFeasibility ? ` ${d.feasibility?.total ?? '-'}/100 |` : ''}\n\n`;
    if (d.feasibility) {
      md += `> リソース: ${d.feasibility.resource} / 技術容易性: ${d.feasibility.techDifficulty} / 組織受容性: ${d.feasibility.orgAcceptance}\n\n`;
    }
  });
  
  if (results.refinements?.length) {
    md += `---\n\n## ブラッシュアップ\n\n`;
    results.refinements.forEach((r, i) => {
      if (results.refinements!.length > 1) md += `### ${i + 1}. レビュー: ${r.review}\n\n`;
      else md += `> レビュー: ${r.review}\n\n`;
      md += `${r.answer}\n\n`;
    });
  } else if (results.refinement) {
    md += `---\n\n## ブラッシュアップ\n\n${results.refinement}\n`;
  }
  
  if (results.deepDives?.length) {
    md += `---\n\n## 深掘り\n\n`;
    results.deepDives.forEach((dd, i) => {
      md += `### ${i + 1}. ${dd.question}\n\n${dd.answer}\n\n`;
    });
  } else if (results.deepDive) {
    md += `---\n\n## 深掘り\n\n${results.deepDive}\n`;
  }
  
  md += `\n---\n*Generated by AI Strategic Brainstorm*`;
  return md;
};

export const mdToTxt = (md: string): string =>
  md
    .replace(/^# (.*$)/gm, '$1')
    .replace(/^## (.*$)/gm, '■ $1')
    .replace(/^### (.*$)/gm, '  $1')
    .replace(/\*\*(.*?)\*\*/g, '$1')
    .replace(/^- (.*$)/gm, '・$1')
    .replace(/\|/g, ' ')
    .replace(/[-]{3,}/g, '────────────────────')
    .replace(/\n{3,}/g, '\n\n')
    .trim();

export const buildReportCsv = (
  pn: string,
  form: BrainstormForm,
  results: AIResults,
  mL: string,
  dep: number
): string => {
  const esc = (s: string) => `"${s.replace(/"/g, '""')}"`;
  const ses = form.sessionType === 'other' ? form.customSession : TYPES[form.sessionType];
  const rows: string[] = [];
  rows.push('No,タイトル,説明,優先度,工数,インパクト,実現可能性(総合),リソース,技術容易性,組織受容性');
  results.ideas.forEach((d, i) => {
    const f = d.feasibility;
    rows.push(`${i + 1},${esc(d.title)},${esc(d.description)},${d.priority},${d.effort},${d.impact},${f?.total ?? ''},${f?.resource ?? ''},${f?.techDifficulty ?? ''},${f?.orgAcceptance ?? ''}`);
  });
  rows.push('');
  rows.push(`プロジェクト,${esc(pn)}`);
  rows.push(`プロダクト/サービス,${esc(form.productService)}`);
  rows.push(`セッション種別,${esc(ses)}`);
  rows.push(`分析深度,${PRO_DEPTH[dep]?.label ?? `Lv${dep}`}`);
  rows.push(`使用モデル,${esc(mL)}`);
  rows.push(`生成日時,${new Date().toLocaleString('ja-JP')}`);
  return rows.join('\n');
};

export const printReport = (txt: string, pn: string) => {
  const w = window.open('', '_blank');
  if (!w) return;
  w.document.write(
    `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${pn}</title><style>body{font-family:-apple-system,'Hiragino Sans',sans-serif;max-width:780px;margin:32px auto;padding:0 20px;color:#1a1a1a;line-height:1.8;font-size:13px}pre{white-space:pre-wrap;font-family:inherit}@media print{body{margin:16px}}</style></head><body><pre>${txt}</pre></body></html>`,
  );
  w.document.close();
  setTimeout(() => w.print(), 300);
};

export const dlFile = (c: string, fn: string, mime: string) => {
  const b = new Blob(['\uFEFF' + c], { type: `${mime};charset=utf-8` });
  const u = URL.createObjectURL(b);
  Object.assign(document.createElement('a'), { href: u, download: fn }).click();
  URL.revokeObjectURL(u);
};

/** Markdown → HTML 簡易変換 */
const mdToHtml = (md: string): string =>
  md
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/\n{2,}/g, '<br/><br/>')
    .replace(/^---$/gm, '<hr/>')
    .replace(/\|(.+)\|\n\|[-| ]+\|\n/gm, (_, header: string) => {
      const cols = header.split('|').map((c: string) => `<th>${c.trim()}</th>`).join('');
      return `<table><thead><tr>${cols}</tr></thead><tbody>`;
    })
    .replace(/\|(.+)\|/gm, (_, row: string) => {
      const cols = row.split('|').map((c: string) => `<td>${c.trim()}</td>`).join('');
      return `<tr>${cols}</tr>`;
    })
    .replace(/(<tr>.*<\/tr>\n?)(?=<[^t]|$)/g, '$&</tbody></table>');

/** PDF ダウンロード（html2pdf.js による生成） */
export const downloadPdf = async (md: string, pn: string) => {
  const { default: html2pdf } = await import('html2pdf.js');
  const html = mdToHtml(md);
  const container = document.createElement('div');
  container.innerHTML = html;
  container.style.cssText = 'font-family:-apple-system,"Hiragino Sans",sans-serif;font-size:12px;line-height:1.7;color:#1a1a1a;max-width:700px;padding:20px';
  container.querySelectorAll('h1').forEach(el => { el.style.cssText = 'font-size:18px;margin:16px 0 8px;border-bottom:2px solid #2563eb;padding-bottom:4px' });
  container.querySelectorAll('h2').forEach(el => { el.style.cssText = 'font-size:15px;margin:14px 0 6px;color:#1e40af' });
  container.querySelectorAll('h3').forEach(el => { el.style.cssText = 'font-size:13px;margin:10px 0 4px;color:#334155' });
  container.querySelectorAll('table').forEach(el => { el.style.cssText = 'border-collapse:collapse;width:100%;margin:8px 0;font-size:11px' });
  container.querySelectorAll('th,td').forEach(el => { (el as HTMLElement).style.cssText = 'border:1px solid #cbd5e1;padding:4px 8px;text-align:left' });
  container.querySelectorAll('th').forEach(el => { el.style.cssText += ';background:#f1f5f9;font-weight:600' });
  container.querySelectorAll('blockquote').forEach(el => { el.style.cssText = 'border-left:3px solid #93c5fd;padding-left:12px;margin:8px 0;color:#475569' });

  await html2pdf().set({
    margin: [10, 10, 10, 10],
    filename: `${pn}.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
  } as Record<string, unknown>).from(container).save();
};

/** PPTX エクスポート */
export const downloadPptx = async (
  pn: string,
  form: BrainstormForm,
  results: AIResults,
  provN: string,
  dep: number,
) => {
  const PptxGenJS = (await import('pptxgenjs')).default;
  const pptx = new PptxGenJS();
  pptx.layout = 'LAYOUT_16x9';
  pptx.author = 'AI Strategic Brainstorm';
  pptx.title = pn;

  const ses = form.sessionType === 'other' ? form.customSession : TYPES[form.sessionType];
  const BLUE = '2563EB';
  const DARK = '1E293B';
  const GRAY = '64748B';

  // --- タイトルスライド ---
  const title = pptx.addSlide();
  title.addText(pn, { x: 0.8, y: 1.5, w: 8.4, h: 1.2, fontSize: 28, bold: true, color: DARK });
  title.addText([
    { text: `${form.productService}  |  ${ses}  |  ${PRO_DEPTH[dep]?.label ?? `Lv${dep}`}`, options: { fontSize: 14, color: GRAY } },
  ], { x: 0.8, y: 2.8, w: 8.4 });
  title.addText(`${provN}  |  ${new Date().toLocaleString('ja-JP')}`, { x: 0.8, y: 4.2, w: 8.4, fontSize: 10, color: GRAY });

  // --- 目標 & 課題 ---
  const goalSlide = pptx.addSlide();
  goalSlide.addText('目標 & 課題', { x: 0.5, y: 0.3, w: 9, fontSize: 20, bold: true, color: BLUE });
  goalSlide.addText(form.teamGoals, { x: 0.5, y: 1.0, w: 9, h: 1.5, fontSize: 13, color: DARK, valign: 'top' });
  const issueTexts = form.issues.filter(x => x.text.trim()).map(x => x.text + (x.detail ? `: ${x.detail}` : ''));
  if (issueTexts.length) {
    goalSlide.addText(issueTexts.map(t => ({ text: t, options: { bullet: true, fontSize: 12, color: DARK, breakLine: true } })), { x: 0.5, y: 2.8, w: 9, h: 2.2, valign: 'top' });
  }

  // --- 状況分析 ---
  const underSlide = pptx.addSlide();
  underSlide.addText('AI 状況分析', { x: 0.5, y: 0.3, w: 9, fontSize: 20, bold: true, color: BLUE });
  const underText = results.understanding.length > 800 ? results.understanding.slice(0, 800) + '…' : results.understanding;
  underSlide.addText(underText, { x: 0.5, y: 1.0, w: 9, h: 4.0, fontSize: 11, color: DARK, valign: 'top' });

  // --- アイデア一覧テーブル ---
  const tableSlide = pptx.addSlide();
  tableSlide.addText('戦略アイデア一覧', { x: 0.5, y: 0.3, w: 9, fontSize: 20, bold: true, color: BLUE });
  const hasFeas = results.ideas.some(d => d.feasibility);
  const headerRow = ['#', 'タイトル', '優先度', '工数', 'インパクト'];
  if (hasFeas) headerRow.push('実現可能性');
  const rows = results.ideas.map((d, i) => {
    const row = [`${i + 1}`, d.title, d.priority, d.effort, d.impact];
    if (hasFeas) row.push(d.feasibility ? `${d.feasibility.total}/100` : '-');
    return row;
  });
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  tableSlide.addTable([headerRow, ...rows] as any, {
    x: 0.3, y: 1.0, w: 9.4,
    fontSize: 10,
    border: { type: 'solid', pt: 0.5, color: 'CBD5E1' },
    colW: hasFeas ? [0.4, 3.5, 1.1, 1.1, 1.1, 1.2] : [0.5, 4.5, 1.3, 1.3, 1.4],
    autoPage: true,
    autoPageRepeatHeader: true,
    rowH: 0.4,
  });

  // --- 各アイデア詳細 ---
  results.ideas.forEach((d, i) => {
    const slide = pptx.addSlide();
    slide.addText(`${i + 1}. ${d.title}`, { x: 0.5, y: 0.3, w: 9, fontSize: 18, bold: true, color: DARK });
    const desc = d.description.length > 600 ? d.description.slice(0, 600) + '…' : d.description;
    slide.addText(desc, { x: 0.5, y: 1.0, w: 9, h: 2.5, fontSize: 11, color: DARK, valign: 'top' });
    const meta = `優先度: ${d.priority}  |  工数: ${d.effort}  |  インパクト: ${d.impact}`;
    slide.addText(meta, { x: 0.5, y: 3.8, w: 9, fontSize: 10, color: GRAY });
    if (d.feasibility) {
      slide.addText(`実現可能性: ${d.feasibility.total}/100  (リソース: ${d.feasibility.resource} / 技術: ${d.feasibility.techDifficulty} / 組織: ${d.feasibility.orgAcceptance})`, { x: 0.5, y: 4.2, w: 9, fontSize: 10, color: GRAY });
    }
  });

  await pptx.writeFile({ fileName: `${pn}.pptx` });
};
