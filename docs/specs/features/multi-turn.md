# 機能: マルチターン対話（深掘り・ブラッシュアップ・ドリルダウン）

## 概要

初回の AI 分析結果に対して、ユーザーが追加の質問やフィードバックを投げることで、
段階的に分析を深められるマルチターン対話機能。

## ユーザーストーリー

- 営業担当として、AI が提案したアイデアの実行手順を深掘りしたい
- 経営企画として、AI 分析に対して「もっと具体的に」とフィードバックを送り、改善された結果を得たい
- マーケ担当として、特定のアイデアをサブ戦略に分解して検討したい

## 3つの対話モード

### 1. 深掘り（Deep Dive）

**入力**: ユーザーの質問テキスト + サジェスション候補からの選択
**出力**: `DeepDiveEntry { question, answer }`

- セッション種別・課題に応じたサジェスション質問を提示
- 直近10メッセージの会話履歴を文脈として送信
- フォールバック: 構造化テーブル形式（Why / What / How / So What + 仮説・検証基準）

### 2. ブラッシュアップ（Refinement）

**入力**: ユーザーのレビューコメント
**出力**: `RefinementEntry { review, answer, results? }`

- keyIssue + funnelStage を文脈に注入
- 直近10メッセージの会話履歴を文脈として送信
- 構造化結果（ideas[] の更新）を含む場合がある

### 3. ドリルダウン（Drill Down）

**入力**: 特定の `Idea` オブジェクト
**出力**: `Idea.subIdeas[]`（3-5件のサブアイデア）

- 選択したアイデアを深掘りし、実行可能なサブ戦略に分解
- 各サブアイデアにも priority / effort / impact を付与

## 会話コンテキスト管理

- `ChatMessage[]` で会話履歴を保持
- 直近 `MAX_HIST`（10件）のメッセージを API に送信
- システムメッセージ + 会話履歴 + 新規ユーザーメッセージの構成

## 制約

- max_tokens: 4,096（リファイン/深掘り共通）
- 会話履歴は localStorage に含まれない（セッション内のみ）
- フォールバック深掘り（テーブル形式）は API エラー時の代替出力

## 実装ファイル

| ファイル | 関数/行 |
|---------|---------|
| `src/hooks/useAI.ts` | `refine()` (L216-298), `deepDive()` (L382-449), `drillDownIdea()` (L451-500+) |
| `src/constants/prompts.ts` | `SUGGEST`, `getDeepDiveSuggestions()` |
| `src/components/layout/ResultsPane.tsx` | 深掘り UI、ブラッシュアップ UI |
| `src/components/results/ResultCard.tsx` | ドリルダウンボタン、subIdeas 再帰表示 |

## 受入基準

- [ ] 深掘り質問に対して文脈を踏まえた回答が返る
- [ ] ブラッシュアップで既存アイデアの改善提案が返る
- [ ] ドリルダウンで 3-5 件のサブアイデアが生成される
- [ ] 会話履歴が蓄積され、後続の質問に文脈が反映される
- [ ] セッション種別に応じたサジェスション質問が表示される
- [ ] API エラー時にフォールバック形式で回答が生成される
